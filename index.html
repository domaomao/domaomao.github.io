<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2048 Game</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f8fafc; }
        h1 { margin-top: 30px; }
        #score { font-size: 24px; margin: 18px; }
        #board {
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(4, 80px);
            grid-gap: 8px;
            background: #dbeafe;
            padding: 10px;
            border-radius: 16px;
            width: max-content;
        }
        .tile {
            width: 80px; height: 80px;
            display: flex; align-items: center; justify-content: center;
            background: #e5e7eb;
            font-size: 28px; font-weight: bold;
            border-radius: 10px;
            transition: background 0.12s, color 0.12s;
        }
        .tile[data-value="2"]    { background: #fef2f2; color: #be185d;}
        .tile[data-value="4"]    { background: #fce7f3; color: #c026d3;}
        .tile[data-value="8"]    { background: #f3e8ff; color: #7c3aed;}
        .tile[data-value="16"]   { background: #ede9fe; color: #7e22ce;}
        .tile[data-value="32"]   { background: #f3f4f6; color: #0369a1;}
        .tile[data-value="64"]   { background: #cffafe; color: #059669;}
        .tile[data-value="128"]  { background: #dcfce7; color: #16a34a;}
        .tile[data-value="256"]  { background: #fef9c3; color: #ca8a04;}
        .tile[data-value="512"]  { background: #fef2f2; color: #991b1b;}
        .tile[data-value="1024"] { background: #f4f4f5; color: #312e81;}
        .tile[data-value="2048"] { background: #fff; color: #d97706;}
        button {
            margin: 15px;
            padding: 10px 20px;
            font-size: 16px; border-radius: 8px;
            background: #1d4ed8; color: #fff; border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background: #2563eb; }
        .msg { font-size: 20px; margin: 16px; color: #991b1b;}
    </style>
</head>
<body>
    <h1>2048 æ¸¸æˆç½‘ç«™</h1>
    <p style="color:#555;">ç©æ³•ï¼šç”¨é”®ç›˜ç®­å¤´æ–¹å‘ï¼ˆâ†‘â†â†“â†’ï¼‰æˆ–è§¦æ‘¸æ»‘åŠ¨æ¥åˆå¹¶æ•°å­—ï¼Œå‡‘å‡º 2048ã€‚ğŸ˜€</p>
    <div id="score">å¾—åˆ†: 0</div>
    <div id="board"></div>
    <div id="game-msg" class="msg"></div>
    <button onclick="restartGame()">é‡æ–°å¼€å§‹</button>

    <script>
        let size = 4;
        let board = Array.from({length: size}, () => Array(size).fill(0));
        let score = 0;
        let gameOver = false;

        function randTile() {
            return Math.random() > 0.9 ? 4 : 2;
        }

        function addRandomTile() {
            let empties = [];
            for(let r = 0; r < size; r++)
                for(let c = 0; c < size; c++)
                    if(board[r][c]==0) empties.push([r,c]);
            if(empties.length === 0) return false;
            let [r,c] = empties[Math.floor(Math.random() * empties.length)];
            board[r][c] = randTile();
            return true;
        }

        function drawBoard() {
            let b = document.getElementById('board');
            b.innerHTML = '';
            for(let r = 0; r < size; r++)
                for(let c = 0; c < size; c++) {
                    let div = document.createElement('div');
                    div.className = 'tile';
                    let v = board[r][c];
                    div.dataset.value = v;
                    div.textContent = v ? v : '';
                    b.appendChild(div);
                }
            document.getElementById('score').innerText = 'å¾—åˆ†: ' + score;
        }

        function restartGame() {
            board = Array.from({length: size}, () => Array(size).fill(0));
            score = 0;
            gameOver = false;
            document.getElementById('game-msg').innerText = '';
            addRandomTile(); addRandomTile();
            drawBoard();
        }

        function canMove() {
            for(let r=0; r<size; r++)
                for(let c=0; c<size; c++) {
                    if(board[r][c]==0) return true;
                    if(r<size-1 && board[r][c]==board[r+1][c]) return true;
                    if(c<size-1 && board[r][c]==board[r][c+1]) return true;
                }
            return false;
        }

        function move(dir) {
            let moved = false;
            let merged = Array.from({length:size},()=>Array(size).fill(false));
            let orig = board.map(row=>row.slice());
            let delta = {ArrowUp:[-1,0], ArrowDown:[1,0], ArrowLeft:[0,-1], ArrowRight:[0,1]};
            let [dr,dc]=delta[dir];

            function step() {
                let hasMoved = false;
                let order = (dr>0||dc>0) ? [...Array(size).keys()].reverse() : [...Array(size).keys()];
                for(let r of order)
                    for(let c of order) {
                        let nr=r+dr, nc=c+dc;
                        if(
                            nr>=0 && nr<size && nc>=0 && nc<size &&
                            board[r][c]!=0 && (board[nr][nc]==0 || (board[nr][nc]==board[r][c]&&!merged[nr][nc]))
                        ){
                            if(board[nr][nc]==0){
                                board[nr][nc]=board[r][c]; board[r][c]=0; hasMoved=true;
                            }
                            else if(board[nr][nc]==board[r][c]) {
                                board[nr][nc]*=2; board[r][c]=0; score+=board[nr][nc];
                                merged[nr][nc]=true; hasMoved=true;
                            }
                        }
                    }
                return hasMoved;
            }

            let movedOnce = false;
            while(step()){movedOnce=true;}
            return movedOnce && JSON.stringify(orig)!=JSON.stringify(board);
        }

        function showMsg(msg){
            document.getElementById('game-msg').innerText=msg;
        }

        document.addEventListener('keydown', function(e){
            if(gameOver) return;
            let dirs = ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'];
            if(!dirs.includes(e.key)) return;
            let didMove = move(e.key);
            if(didMove){
                addRandomTile();
                drawBoard();
                if(!canMove()){
                    showMsg('æ¸¸æˆç»“æŸï¼åˆ·æ–°æˆ–é‡æ–°å¼€å§‹ã€‚');
                    gameOver = true;
                }
                if(board.flat().includes(2048)){
                    showMsg('æ­å–œä½ è¾¾æˆ 2048ï¼ğŸ‰ å¯ä»¥ç»§ç»­æŒ‘æˆ˜æ›´é«˜åˆ†ï¼');
                    gameOver = true; // å¯æ³¨é‡Šæ‰å…è®¸ç»§ç»­
                }
            }
        });

        // ç§»åŠ¨ç«¯æ»‘åŠ¨æ”¯æŒ
        let touchStartX, touchStartY, touchEndX, touchEndY;
        document.body.addEventListener('touchstart', function(e){
            let t=e.touches[0];
            touchStartX=t.clientX; touchStartY=t.clientY;
        });
        document.body.addEventListener('touchend', function(e){
            let t=e.changedTouches[0];
            touchEndX=t.clientX; touchEndY=t.clientY;
            let dx=touchEndX-touchStartX, dy=touchEndY-touchStartY;
            let absdx=Math.abs(dx), absdy=Math.abs(dy);
            if(absdx<20 && absdy<20) return;
            let dir = absdx>absdy ? (dx>0?'ArrowRight':'ArrowLeft') : (dy>0?'ArrowDown':'ArrowUp');
            let didMove = move(dir);
            if(didMove){
                addRandomTile();
                drawBoard();
                if(!canMove()){
                    showMsg('æ¸¸æˆç»“æŸï¼åˆ·æ–°æˆ–é‡æ–°å¼€å§‹ã€‚');
                    gameOver = true;
                }
                if(board.flat().includes(2048)){
                    showMsg('æ­å–œä½ è¾¾æˆ 2048ï¼ğŸ‰ å¯ä»¥ç»§ç»­æŒ‘æˆ˜æ›´é«˜åˆ†ï¼');
                    gameOver = true;
                }
            }
        });

        restartGame();
    </script>
</body>
</html>
